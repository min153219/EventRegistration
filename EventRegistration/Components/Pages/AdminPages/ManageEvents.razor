@page "/admin/manage-events"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using EventRegistration.Domain
@using EventRegistration.Data
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize(Roles = "Administrator")]
@implements IAsyncDisposable
@inject IDbContextFactory<EventRegistrationContext> DbFactory
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Manage Events - Admin</PageTitle>

<div class="container">
    <div class="page-header">
        <h1>Manage Events</h1>
        <p class="subtitle">Review and approve/reject events submitted by users</p>
    </div>

    <!-- Status Filter Tabs -->
    <div class="tabs">
        <button type="button" class="tab @(statusFilter == "All" ? "tab-active" : "")" @onclick="@(() => FilterByStatus("All"))">
            All Events (@totalEvents)
        </button>
        <button type="button" class="tab @(statusFilter == "Pending" ? "tab-active" : "")" @onclick="@(() => FilterByStatus("Pending"))">
            Pending (@pendingCount)
        </button>
        <button type="button" class="tab @(statusFilter == "Approved" ? "tab-active" : "")" @onclick="@(() => FilterByStatus("Approved"))">
            Approved (@approvedCount)
        </button>
        <button type="button" class="tab @(statusFilter == "Rejected" ? "tab-active" : "")" @onclick="@(() => FilterByStatus("Rejected"))">
            Rejected (@rejectedCount)
        </button>
    </div>

    @if (events == null || !events.Any())
    {
        <div class="alert alert-info">
            No events found.
        </div>
    }
    else
    {
        <div class="table-container">
            <table class="events-table">
                <thead>
                    <tr>
                        <th>Event Title</th>
                        <th>Type</th>
                        <th>Event Date</th>
                        <th>Location</th>
                        <th>Category</th>
                        <th>Created By</th>
                        <th>Submitted</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var e in filteredEvents ?? Enumerable.Empty<Event>())
                    {
                        <tr>
                            <td>@e.Title</td>
                            <td>@e.Type</td>
                            <td>@e.EventDate.ToString("MMM dd, yyyy")</td>
                            <td>@e.Location</td>
                            <td>@e.Category</td>
                            <td><small>@e.CreatedBy</small></td>
                            <td>@e.DateCreated.ToString("MMM dd, yyyy")</td>
                            <td>
                                <span class="badge @GetStatusBadgeClass(e.Status)">
                                    @e.Status
                                </span>
                                @if (!string.IsNullOrEmpty(e.ReviewedBy))
                                {
                                    <div class="reviewer-info">
                                        by @e.ReviewedBy
                                    </div>
                                }
                            </td>
                            <td>
                                @{
                                    var currentEvent = e;
                                }
                                <div class="action-buttons">
                                    @if (currentEvent.Status == "Pending")
                                    {
                                        <button type="button" class="btn btn-success" @onclick="() => ShowApproveModal(currentEvent)">
                                            Approve
                                        </button>
                                        <button type="button" class="btn btn-danger" @onclick="() => ShowRejectModal(currentEvent)">
                                            Reject
                                        </button>
                                    }
                                    else if (currentEvent.Status == "Approved")
                                    {
                                        <button type="button" class="btn btn-warning" @onclick="() => ShowRejectModal(currentEvent)">
                                            Revoke
                                        </button>
                                    }
                                    else if (currentEvent.Status == "Rejected")
                                    {
                                        <button type="button" class="btn btn-success" @onclick="() => ShowApproveModal(currentEvent)">
                                            Approve
                                        </button>
                                    }
                                    <a href="@($"/events/details/{currentEvent.Id}")" class="btn btn-secondary">
                                        View
                                    </a>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<!-- Approve Modal -->
@if (showApproveModal && selectedEvent != null)
{
    <div class="modal-overlay" @onclick="CloseModals"></div>
    <div class="modal">
        <div class="modal-dialog">
            <div class="modal-header modal-header-success">
                <h5 class="modal-title">Approve Event</h5>
                <button type="button" class="close-button" @onclick="CloseModals">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to approve this event?</p>
                <div class="event-card">
                    <h6>@selectedEvent.Title</h6>
                    <p>
                        <strong>Type:</strong> @selectedEvent.Type<br />
                        <strong>Date:</strong> @selectedEvent.EventDate.ToString("MMMM dd, yyyy")<br />
                        <strong>Location:</strong> @selectedEvent.Location<br />
                        <strong>Created by:</strong> @selectedEvent.CreatedBy
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="CloseModals">Cancel</button>
                <button type="button" class="btn btn-success" @onclick="ApproveEvent">
                    Approve Event
                </button>
            </div>
        </div>
    </div>
}

<!-- Reject Modal -->
@if (showRejectModal && selectedEvent != null)
{
    <div class="modal-overlay" @onclick="CloseModals"></div>
    <div class="modal">
        <div class="modal-dialog">
            <div class="modal-header modal-header-danger">
                <h5 class="modal-title">Reject Event</h5>
                <button type="button" class="close-button" @onclick="CloseModals">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to reject this event?</p>
                <div class="event-card">
                    <h6>@selectedEvent.Title</h6>
                    <p>
                        <strong>Type:</strong> @selectedEvent.Type<br />
                        <strong>Date:</strong> @selectedEvent.EventDate.ToString("MMMM dd, yyyy")<br />
                        <strong>Location:</strong> @selectedEvent.Location<br />
                        <strong>Created by:</strong> @selectedEvent.CreatedBy
                    </p>
                </div>
                <div class="form-group">
                    <label for="rejectionReason" class="label-danger">
                        Reason for Rejection (Required):
                    </label>
                    <textarea id="rejectionReason" @bind="rejectionReason" @bind:event="oninput"
                              class="textarea" rows="3"
                              placeholder="Provide a clear reason for rejection so the creator understands why..."></textarea>
                    @if (string.IsNullOrWhiteSpace(rejectionReason))
                    {
                        <small class="error-text">Please enter a rejection reason</small>
                    }
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="CloseModals">Cancel</button>
                <button type="button" class="btn btn-danger" @onclick="RejectEvent" disabled="@string.IsNullOrWhiteSpace(rejectionReason)">
                    Reject Event
                </button>
            </div>
        </div>
    </div>
}

@code {
    private EventRegistrationContext context = default!;
    private string? currentAdminEmail;
    private List<Event>? events;
    private IEnumerable<Event>? filteredEvents;

    private string statusFilter = "Pending";
    private int totalEvents = 0;
    private int pendingCount = 0;
    private int approvedCount = 0;
    private int rejectedCount = 0;

    private bool showApproveModal = false;
    private bool showRejectModal = false;
    private Event? selectedEvent;
    private string rejectionReason = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        context = DbFactory.CreateDbContext();

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        currentAdminEmail = authState.User.Identity?.Name;

        await LoadEvents();
    }

    private async Task LoadEvents()
    {
        events = await context.Event
            .AsNoTracking()
            .OrderByDescending(e => e.DateCreated)
            .ToListAsync();

        totalEvents = events.Count;
        pendingCount = events.Count(e => e.Status == "Pending");
        approvedCount = events.Count(e => e.Status == "Approved");
        rejectedCount = events.Count(e => e.Status == "Rejected");

        FilterByStatus(statusFilter);
    }

    private void FilterByStatus(string status)
    {
        statusFilter = status;

        if (status == "All")
        {
            filteredEvents = events;
        }
        else
        {
            filteredEvents = events?.Where(e => e.Status == status);
        }

        StateHasChanged();
    }

    private void ShowApproveModal(Event evt)
    {
        selectedEvent = evt;
        showApproveModal = true;
        showRejectModal = false;
        StateHasChanged();
        Console.WriteLine($"ShowApproveModal called for: {evt.Title}");
    }

    private void ShowRejectModal(Event evt)
    {
        selectedEvent = evt;
        rejectionReason = selectedEvent.RejectionReason ?? string.Empty;
        showRejectModal = true;
        showApproveModal = false;
        StateHasChanged();
        Console.WriteLine($"ShowRejectModal called for: {evt.Title}");
    }

    private void CloseModals()
    {
        showApproveModal = false;
        showRejectModal = false;
        selectedEvent = null;
        rejectionReason = string.Empty;
        StateHasChanged();
    }

    private async Task ApproveEvent()
    {
        if (selectedEvent == null) return;

        try
        {
            Console.WriteLine($"Approving event: {selectedEvent.Id}");

            var eventToUpdate = await context.Event.FindAsync(selectedEvent.Id);
            if (eventToUpdate != null)
            {
                eventToUpdate.Status = "Approved";
                eventToUpdate.ReviewedBy = currentAdminEmail;
                eventToUpdate.ReviewedDate = DateTime.Now;
                eventToUpdate.RejectionReason = null;
                eventToUpdate.DateUpdated = DateTime.Now;
                eventToUpdate.UpdatedBy = currentAdminEmail;

                await context.SaveChangesAsync();
                Console.WriteLine("Event approved successfully");
            }

            CloseModals();
            await LoadEvents();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error approving event: {ex.Message}");
        }
    }

    private async Task RejectEvent()
    {
        if (selectedEvent == null || string.IsNullOrWhiteSpace(rejectionReason))
        {
            Console.WriteLine("Cannot reject: selectedEvent is null or rejection reason is empty");
            return;
        }

        try
        {
            Console.WriteLine($"Rejecting event: {selectedEvent.Id} with reason: {rejectionReason}");

            var eventToUpdate = await context.Event.FindAsync(selectedEvent.Id);
            if (eventToUpdate != null)
            {
                eventToUpdate.Status = "Rejected";
                eventToUpdate.ReviewedBy = currentAdminEmail;
                eventToUpdate.ReviewedDate = DateTime.Now;
                eventToUpdate.RejectionReason = rejectionReason.Trim();
                eventToUpdate.DateUpdated = DateTime.Now;
                eventToUpdate.UpdatedBy = currentAdminEmail;

                await context.SaveChangesAsync();
                Console.WriteLine("Event rejected successfully");
            }

            CloseModals();
            await LoadEvents();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error rejecting event: {ex.Message}");
        }
    }

    private string GetStatusBadgeClass(string? status)
        => status switch
        {
            "Pending" => "badge-warning",
            "Approved" => "badge-success",
            "Rejected" => "badge-danger",
            _ => "badge-secondary"
        };

    public async ValueTask DisposeAsync() => await context.DisposeAsync();
}