@page "/events"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.QuickGrid
@using EventRegistration.Domain
@using EventRegistration.Data
@using Microsoft.AspNetCore.Components.Authorization
@implements IAsyncDisposable
@inject IDbContextFactory<EventRegistrationContext> DbFactory
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation

<PageTitle>My Events</PageTitle>

<div class="page-container">
    <div class="page-header">
        <div class="header-content">
            <h1>@(isAdmin ? "All Events" : "My Events")</h1>
            <p class="subtitle">
                @if (isAdmin)
                {
                    <span>View all events in the system. Use <a href="/admin/manage-events">Manage Events</a> to approve/reject events.</span>
                }
                else
                {
                    <span>View and manage your created events</span>
                }
            </p>
        </div>
        <div class="header-actions">
            @if (!isAdmin)
            {
                <a href="/events/create" class="btn btn-primary">
                    Create New Event
                </a>
            }
            else
            {
                <a href="/admin/manage-events" class="btn btn-warning">
                    Manage Events
                </a>
            }
        </div>
    </div>

    @if (events == null || !events.Any())
    {
        <div class="alert alert-info">
            @if (isAdmin)
            {
                <span>No events found in the system.</span>
            }
            else
            {
                <span>You haven't created any events yet. <a href="/events/create">Create your first event</a>!</span>
            }
        </div>
    }
    else
    {
        <div class="events-table-container">
            <QuickGrid TGridItem="Event" Class="events-table" Items="filteredEvents">
                <TemplateColumn Title="Event Title" Sortable="true" SortBy="@(GridSort<Event>.ByAscending(e => e.Title))" Context="e">
                    @if (!isAdmin && e.CreatedBy == currentUserEmail)
                    {
                        <a href="@($"/events/{e.Id}/tickets")" class="event-title-link">
                            @e.Title
                        </a>
                    }
                    else
                    {
                        <span class="event-title">@e.Title</span>
                    }
                </TemplateColumn>

                <PropertyColumn Property="e => e.Type" Sortable="true" />
                <PropertyColumn Property="e => e.EventDate" Format="MMM dd, yyyy" Sortable="true" Title="Event Date" />
                <PropertyColumn Property="e => e.Location" />
                <PropertyColumn Property="e => e.Category" Sortable="true" />

                @if (isAdmin)
                {
                    <PropertyColumn Property="e => e.CreatedBy" Title="Created By" Sortable="true" />
                }

                <PropertyColumn Property="e => e.DateCreated" Format="MMM dd, yyyy" Title="Created" Sortable="true" />

                <TemplateColumn Title="Status" Context="e">
                    <span class="status-badge status-@e.Status?.ToLower()">
                        @e.Status
                    </span>
                </TemplateColumn>

                <TemplateColumn Title="Actions" Context="e">
                    <div class="action-buttons">
                        @if (isAdmin)
                        {
                            <a href="@($"/events/details/{e.Id}")" class="btn btn-secondary">
                                View
                            </a>
                            <a href="/admin/manage-events" class="btn btn-warning">
                                Manage
                            </a>
                        }
                        else if (e.CreatedBy == currentUserEmail)
                        {
                            @if (e.Status == "Pending")
                            {
                                <a href="@($"/events/edit/{e.Id}")" class="btn btn-primary">
                                    Edit
                                </a>
                            }
                            <a href="@($"/events/{e.Id}/tickets")" class="btn btn-success">
                                Tickets
                            </a>
                            <a href="@($"/events/{e.Id}/payments")" class="btn btn-info">
                                Payments
                            </a>
                            <a href="@($"/events/delete/{e.Id}")" class="btn btn-danger">
                                Delete
                            </a>
                            <a href="@($"/events/details/{e.Id}")" class="btn btn-secondary">
                                Details
                            </a>
                        }
                    </div>
                </TemplateColumn>
            </QuickGrid>
        </div>
    }
</div>

@code {
    private EventRegistrationContext context = default!;
    private string? currentUserEmail;
    private bool isAdmin = false;
    private List<Event>? events;
    private IQueryable<Event>? filteredEvents;

    protected override async Task OnInitializedAsync()
    {
        context = DbFactory.CreateDbContext();

        // Get current user info
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        currentUserEmail = authState.User.Identity?.Name;
        isAdmin = authState.User.IsInRole("Administrator");

        // Redirect admins directly to Manage Events page
        if (isAdmin)
        {
            Navigation.NavigateTo("/admin/manage-events", forceLoad: false);
            return;
        }

        // Load events based on role (only for regular users now)
        await LoadEvents();
    }

    private async Task LoadEvents()
    {
        if (isAdmin)
        {
            // Admin sees ALL events
            events = await context.Event
                .AsNoTracking()
                .OrderByDescending(e => e.DateCreated)
                .ToListAsync();
        }
        else
        {
            // Regular users see only THEIR events (excluding Rejected)
            events = await context.Event
                .AsNoTracking()
                .Where(e => e.CreatedBy == currentUserEmail && e.Status != "Rejected")
                .OrderByDescending(e => e.DateCreated)
                .ToListAsync();
        }

        filteredEvents = events.AsQueryable();
    }

    public async ValueTask DisposeAsync() => await context.DisposeAsync();
}
