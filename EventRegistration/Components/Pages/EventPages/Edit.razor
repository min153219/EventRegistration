@page "/events/edit/{id:int}"
@using Microsoft.EntityFrameworkCore
@using EventRegistration.Domain
@using Microsoft.AspNetCore.Components.Authorization
@inject IDbContextFactory<EventRegistration.Data.EventRegistrationContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Edit Event</PageTitle>

<link href="/Edit.razor.css" rel="stylesheet" />

<div class="container">
    <div class="edit-page-header">
        <h1>Edit Event</h1>
    </div>

    @if (isUnauthorized)
    {
        <div class="access-denied-card">
            <h4>Access Denied</h4>
            <p>You don't have permission to edit this event. Only the event creator can edit pending events.</p>
            <a href="/events" class="btn btn-primary">Back to Events</a>
        </div>
    }
    else if (cannotEdit)
    {
        <div class="cannot-edit-card">
            <h4>Cannot Edit</h4>
            <p>This event has been <strong>@selectedEvent?.Status</strong> and cannot be edited. Only events with "Pending" status can be modified.</p>
            <a href="/events" class="btn btn-primary">Back to Events</a>
        </div>
    }
    else if (selectedEvent is null)
    {
        <div class="loading-center">
            <div class="spinner"></div>
            <p><em>Loading event...</em></p>
        </div>
    }
    else
    {
        <div class="edit-layout">
            <div class="edit-main">
                <div class="edit-card">
                    <div class="edit-card-body">
                        <EditForm method="post" Model="@selectedEvent" OnValidSubmit="@UpdateEvent" FormName="EditEventForm" Enhance>
                            <DataAnnotationsValidator />
                            <ValidationSummary class="validation-summary" role="alert" />

                            <input type="hidden" name="selectedEvent.Id" value="@selectedEvent.Id" />

                            <div class="form-group">
                                <label for="title" class="form-label">Title:</label>
                                <InputText id="title" @bind-Value="selectedEvent.Title" class="form-input" name="selectedEvent.Title" />
                                <ValidationMessage For="() => selectedEvent.Title" class="validation-error" />
                            </div>

                            <div class="form-row">
                                <div class="form-col">
                                    <label for="type" class="form-label">Type:</label>
                                    <InputSelect id="type" @bind-Value="selectedEvent.Type" class="form-input" name="selectedEvent.Type">
                                        <option value="">Select Type</option>
                                        <option value="Physical">Physical</option>
                                        <option value="Virtual">Virtual</option>
                                        <option value="Hybrid">Hybrid</option>
                                    </InputSelect>
                                    <ValidationMessage For="() => selectedEvent.Type" class="validation-error" />
                                </div>

                                <div class="form-col">
                                    <label for="eventdate" class="form-label">Event Date:</label>
                                    <InputDate id="eventdate" @bind-Value="selectedEvent.EventDate" class="form-input" name="selectedEvent.EventDate" />
                                    <ValidationMessage For="() => selectedEvent.EventDate" class="validation-error" />
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-col">
                                    <label for="location" class="form-label">Location:</label>
                                    <InputText id="location" @bind-Value="selectedEvent.Location" class="form-input" name="selectedEvent.Location" />
                                    <ValidationMessage For="() => selectedEvent.Location" class="validation-error" />
                                </div>

                                <div class="form-col">
                                    <label for="totalcapacity" class="form-label">Total Capacity:</label>
                                    <InputNumber id="totalcapacity" @bind-Value="selectedEvent.TotalCapacity" class="form-input" name="selectedEvent.TotalCapacity" />
                                    <ValidationMessage For="() => selectedEvent.TotalCapacity" class="validation-error" />
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="category" class="form-label">Category:</label>
                                <InputSelect id="category" @bind-Value="selectedEvent.Category" class="form-input" name="selectedEvent.Category">
                                    <option value="">Select Category</option>
                                    <option value="Music">Music</option>
                                    <option value="Educational">Educational</option>
                                    <option value="Arts">Arts</option>
                                    <option value="Professional">Professional</option>
                                    <option value="Sports">Sports</option>
                                    <option value="Entertainment">Entertainment</option>
                                </InputSelect>
                                <ValidationMessage For="() => selectedEvent.Category" class="validation-error" />
                            </div>

                            <div class="form-group">
                                <label for="description" class="form-label">Description:</label>
                                <InputTextArea id="description" @bind-Value="selectedEvent.Description" class="form-textarea" name="selectedEvent.Description" />
                                <ValidationMessage For="() => selectedEvent.Description" class="validation-error" />
                            </div>

                            <div class="form-row form-row-three">
                                <div class="form-col">
                                    <label for="createdby" class="form-label">Created By:</label>
                                    <input id="createdby" value="@selectedEvent.CreatedBy" class="form-input form-input-disabled" disabled />
                                </div>

                                <div class="form-col">
                                    <label for="datecreated" class="form-label">Date Created:</label>
                                    <input id="datecreated" value="@selectedEvent.DateCreated.ToString("yyyy-MM-dd")" class="form-input form-input-disabled" disabled />
                                </div>

                                <div class="form-col">
                                    <label for="status" class="form-label">Status:</label>
                                    <input id="status" value="@selectedEvent.Status" class="form-input form-input-disabled" disabled />
                                </div>
                            </div>

                            @if (!string.IsNullOrEmpty(selectedEvent.UpdatedBy))
                            {
                                <div class="form-row">
                                    <div class="form-col">
                                        <label for="updatedby" class="form-label">Last Updated By:</label>
                                        <input id="updatedby" value="@selectedEvent.UpdatedBy" class="form-input form-input-disabled" disabled />
                                    </div>

                                    <div class="form-col">
                                        <label for="dateupdated" class="form-label">Last Updated:</label>
                                        <input id="dateupdated" value="@selectedEvent.DateUpdated.ToString("yyyy-MM-dd")" class="form-input form-input-disabled" disabled />
                                    </div>
                                </div>
                            }

                            <div class="edit-actions">
                                <button type="submit" class="btn btn-primary">
                                    Save Changes
                                </button>
                                <a href="/events" class="btn btn-secondary">
                                    Cancel
                                </a>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    [SupplyParameterFromForm]
    private Event? selectedEvent { get; set; }

    private bool isUnauthorized = false;
    private bool cannotEdit = false;

    protected override async Task OnInitializedAsync()
    {
        // Get current user info
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var currentUserEmail = authState.User.Identity?.Name;

        // Only load from database if not coming from form post
        if (selectedEvent is null)
        {
            using var context = DbFactory.CreateDbContext();
            selectedEvent = await context.Event.FirstOrDefaultAsync(m => m.Id == Id);

            if (selectedEvent is null)
            {
                NavigationManager.NavigateTo("/events");
                return;
            }

            // ✅ Check authorization: Only Event Creator (not admin)
            if (selectedEvent.CreatedBy != currentUserEmail)
            {
                isUnauthorized = true;
                return;
            }

            // ✅ Check if event can be edited (only Pending status)
            if (selectedEvent.Status != "Pending")
            {
                cannotEdit = true;
            }
        }
    }

    private async Task UpdateEvent()
    {
        if (selectedEvent is null)
        {
            return;
        }

        // Double-check authorization before saving
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var currentUserEmail = authState.User.Identity?.Name;

        using var context = DbFactory.CreateDbContext();

        // Get the original event from database
        var originalEvent = await context.Event.FindAsync(selectedEvent.Id);

        if (originalEvent == null)
        {
            NavigationManager.NavigateTo("/events");
            return;
        }

        // Only creator can update and only if status is Pending
        if (originalEvent.CreatedBy != currentUserEmail || originalEvent.Status != "Pending")
        {
            NavigationManager.NavigateTo("/events");
            return;
        }

        // Update only the editable fields
        originalEvent.Title = selectedEvent.Title;
        originalEvent.Type = selectedEvent.Type;
        originalEvent.EventDate = selectedEvent.EventDate;
        originalEvent.Location = selectedEvent.Location;
        originalEvent.TotalCapacity = selectedEvent.TotalCapacity;
        originalEvent.Category = selectedEvent.Category;
        originalEvent.Description = selectedEvent.Description;

        // Update audit fields
        originalEvent.DateUpdated = DateTime.Now;
        originalEvent.UpdatedBy = currentUserEmail;

        try
        {
            await context.SaveChangesAsync();
            NavigationManager.NavigateTo("/events");
        }
        catch (DbUpdateConcurrencyException)
        {
            if (!EventExists(selectedEvent.Id))
            {
                NavigationManager.NavigateTo("/events");
            }
            else
            {
                throw;
            }
        }
    }

    private bool EventExists(int id)
    {
        using var context = DbFactory.CreateDbContext();
        return context.Event.Any(e => e.Id == id);
    }
}