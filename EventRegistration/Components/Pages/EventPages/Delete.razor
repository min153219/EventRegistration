@page "/events/delete/{id:int}"
@using Microsoft.EntityFrameworkCore
@using EventRegistration.Domain
@using Microsoft.AspNetCore.Components.Authorization
@inject IDbContextFactory<EventRegistration.Data.EventRegistrationContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Delete Event</PageTitle>

<link href="/Delete.razor.css" rel="stylesheet" />

<div class="container">
    <div class="delete-warning-banner">
        <h4>Confirm Deletion</h4>
        <p>Are you sure you want to delete this event? This action cannot be undone.</p>
    </div>

    @if (isUnauthorized)
    {
        <div class="access-denied-card">
            <h4>Access Denied</h4>
            <p>You don't have permission to delete this event. Only the event creator or administrators can delete it.</p>
            <a href="/events" class="btn btn-primary">Back to Events</a>
        </div>
    }
    else if (selectedEvent is null)
    {
        <div class="loading-center">
            <div class="spinner"></div>
            <p><em>Loading event...</em></p>
        </div>
    }
    else
    {
        <div class="delete-layout">
            <div class="delete-main">
                <div class="delete-card">
                    <div class="delete-card-header">
                        <h5>Event to be Deleted</h5>
                    </div>
                    <div class="delete-card-body">
                        <dl class="detail-list">
                            <div class="detail-row">
                                <dt>Title:</dt>
                                <dd>@selectedEvent.Title</dd>
                            </div>

                            <div class="detail-row">
                                <dt>Type:</dt>
                                <dd>
                                    <span class="badge badge-info">@selectedEvent.Type</span>
                                </dd>
                            </div>

                            <div class="detail-row">
                                <dt>Event Date:</dt>
                                <dd>@selectedEvent.EventDate.ToString("MMMM dd, yyyy")</dd>
                            </div>

                            <div class="detail-row">
                                <dt>Location:</dt>
                                <dd>@selectedEvent.Location</dd>
                            </div>

                            <div class="detail-row">
                                <dt>Capacity:</dt>
                                <dd>@selectedEvent.TotalCapacity</dd>
                            </div>

                            <div class="detail-row">
                                <dt>Category:</dt>
                                <dd>@selectedEvent.Category</dd>
                            </div>

                            <div class="detail-row">
                                <dt>Description:</dt>
                                <dd>@selectedEvent.Description</dd>
                            </div>

                            <div class="detail-row">
                                <dt>Status:</dt>
                                <dd>
                                    <span class="badge @GetStatusBadgeClass(selectedEvent.Status)">
                                        @selectedEvent.Status
                                    </span>
                                </dd>
                            </div>

                            <div class="detail-row">
                                <dt>Created By:</dt>
                                <dd>@selectedEvent.CreatedBy</dd>
                            </div>

                            <div class="detail-row">
                                <dt>Date Created:</dt>
                                <dd>@selectedEvent.DateCreated.ToString("MMM dd, yyyy 'at' h:mm tt")</dd>
                            </div>

                            @if (!string.IsNullOrEmpty(selectedEvent.UpdatedBy))
                            {
                                <div class="detail-row">
                                    <dt>Last Updated By:</dt>
                                    <dd>@selectedEvent.UpdatedBy</dd>
                                </div>

                                <div class="detail-row">
                                    <dt>Last Updated:</dt>
                                    <dd>@selectedEvent.DateUpdated.ToString("MMM dd, yyyy 'at' h:mm tt")</dd>
                                </div>
                            }
                        </dl>
                    </div>
                </div>

                <EditForm method="post" Model="selectedEvent" OnValidSubmit="DeleteEvent" FormName="delete" Enhance>
                    <div class="delete-actions">
                        <button type="submit" class="btn btn-danger" disabled="@(selectedEvent is null)">
                            Yes, Delete This Event
                        </button>
                        <a href="/events" class="btn btn-secondary">
                            Cancel
                        </a>
                    </div>
                </EditForm>
            </div>

            <div class="delete-sidebar">
                <div class="warning-card">
                    <h5>Warning</h5>
                    <p>Deleting this event will permanently remove:</p>
                    <ul>
                        <li>All event information</li>
                        <li>Associated tickets</li>
                        <li>Registration records</li>
                        <li>Payment history</li>
                    </ul>
                    <div class="warning-card-divider"></div>
                    <p class="warning-card-footer">
                        This action cannot be undone. Please make sure you want to proceed.
                    </p>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private Event? selectedEvent;
    private bool isUnauthorized = false;

    protected override async Task OnInitializedAsync()
    {
        // Get current user info
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var currentUserEmail = authState.User.Identity?.Name;
        var isAdmin = authState.User.IsInRole("Administrator");

        using var context = DbFactory.CreateDbContext();
        selectedEvent = await context.Event.FirstOrDefaultAsync(m => m.Id == Id);

        if (selectedEvent is null)
        {
            NavigationManager.NavigateTo("/events");
            return;
        }

        // ✅ Check authorization: Admin OR Event Creator
        if (!isAdmin && selectedEvent.CreatedBy != currentUserEmail)
        {
            isUnauthorized = true;
        }
    }

    private async Task DeleteEvent()
    {
        if (selectedEvent is null)
        {
            return;
        }

        // Double-check authorization before deleting
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var currentUserEmail = authState.User.Identity?.Name;
        var isAdmin = authState.User.IsInRole("Administrator");

        // Only creator or admin can delete
        if (!isAdmin && selectedEvent.CreatedBy != currentUserEmail)
        {
            NavigationManager.NavigateTo("/events");
            return;
        }

        using var context = DbFactory.CreateDbContext();

        // Find and remove the event
        var eventToDelete = await context.Event.FindAsync(selectedEvent.Id);
        if (eventToDelete != null)
        {
            context.Event.Remove(eventToDelete);
            await context.SaveChangesAsync();
        }

        NavigationManager.NavigateTo("/events");
    }

    private string GetStatusBadgeClass(string? status)
        => status switch
        {
            "Pending" => "badge-pending",
            "Approved" => "badge-approved",
            "Rejected" => "badge-rejected",
            _ => "badge-default"
        };
}