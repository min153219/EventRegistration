@page "/events/delete/{id:int}"
@using Microsoft.EntityFrameworkCore
@using EventRegistration.Domain
@using Microsoft.AspNetCore.Components.Authorization
@inject IDbContextFactory<EventRegistration.Data.EventRegistrationContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Delete Event</PageTitle>

<div class="container mt-4">
    <div class="alert alert-warning border-warning">
        <h4 class="alert-heading">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            Confirm Deletion
        </h4>
        <p class="mb-0">Are you sure you want to delete this event? This action cannot be undone.</p>
    </div>

    @if (isUnauthorized)
    {
        <div class="alert alert-danger">
            <h4>Access Denied</h4>
            <p>You don't have permission to delete this event. Only the event creator or administrators can delete it.</p>
            <a href="/events" class="btn btn-primary">Back to Events</a>
        </div>
    }
    else if (selectedEvent is null)
    {
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2"><em>Loading event...</em></p>
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="bi bi-trash me-2"></i>Event to be Deleted</h5>
                    </div>
                    <div class="card-body">
                        <dl class="row mb-0">
                            <dt class="col-sm-3">Title:</dt>
                            <dd class="col-sm-9">@selectedEvent.Title</dd>

                            <dt class="col-sm-3">Type:</dt>
                            <dd class="col-sm-9">
                                <span class="badge bg-info text-dark">@selectedEvent.Type</span>
                            </dd>

                            <dt class="col-sm-3">Event Date:</dt>
                            <dd class="col-sm-9">@selectedEvent.EventDate.ToString("MMMM dd, yyyy")</dd>

                            <dt class="col-sm-3">Location:</dt>
                            <dd class="col-sm-9">@selectedEvent.Location</dd>

                            <dt class="col-sm-3">Capacity:</dt>
                            <dd class="col-sm-9">@selectedEvent.TotalCapacity</dd>

                            <dt class="col-sm-3">Category:</dt>
                            <dd class="col-sm-9">@selectedEvent.Category</dd>

                            <dt class="col-sm-3">Description:</dt>
                            <dd class="col-sm-9">@selectedEvent.Description</dd>

                            <dt class="col-sm-3">Status:</dt>
                            <dd class="col-sm-9">
                                <span class="badge @GetStatusBadgeClass(selectedEvent.Status)">
                                    @selectedEvent.Status
                                </span>
                            </dd>

                            <dt class="col-sm-3">Created By:</dt>
                            <dd class="col-sm-9">@selectedEvent.CreatedBy</dd>

                            <dt class="col-sm-3">Date Created:</dt>
                            <dd class="col-sm-9">@selectedEvent.DateCreated.ToString("MMM dd, yyyy 'at' h:mm tt")</dd>

                            @if (!string.IsNullOrEmpty(selectedEvent.UpdatedBy))
                            {
                                <dt class="col-sm-3">Last Updated By:</dt>
                                <dd class="col-sm-9">@selectedEvent.UpdatedBy</dd>

                                <dt class="col-sm-3">Last Updated:</dt>
                                <dd class="col-sm-9">@selectedEvent.DateUpdated.ToString("MMM dd, yyyy 'at' h:mm tt")</dd>
                            }
                        </dl>
                    </div>
                </div>

                <EditForm method="post" Model="selectedEvent" OnValidSubmit="DeleteEvent" FormName="delete" Enhance>
                    <div class="mt-4 d-flex gap-2">
                        <button type="submit" class="btn btn-danger" disabled="@(selectedEvent is null)">
                            <i class="bi bi-trash me-1"></i> Yes, Delete This Event
                        </button>
                        <a href="/events" class="btn btn-secondary">
                            <i class="bi bi-x-circle me-1"></i> Cancel
                        </a>
                    </div>
                </EditForm>
            </div>

            <div class="col-lg-4">
                <div class="card shadow-sm border-warning">
                    <div class="card-body">
                        <h5 class="card-title text-warning">
                            <i class="bi bi-info-circle me-2"></i>Warning
                        </h5>
                        <p class="card-text">Deleting this event will permanently remove:</p>
                        <ul class="mb-0">
                            <li>All event information</li>
                            <li>Associated tickets</li>
                            <li>Registration records</li>
                            <li>Payment history</li>
                        </ul>
                        <hr>
                        <p class="text-muted mb-0">
                            <small>This action cannot be undone. Please make sure you want to proceed.</small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private Event? selectedEvent;
    private bool isUnauthorized = false;

    protected override async Task OnInitializedAsync()
    {
        // Get current user info
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var currentUserEmail = authState.User.Identity?.Name;
        var isAdmin = authState.User.IsInRole("Administrator");

        using var context = DbFactory.CreateDbContext();
        selectedEvent = await context.Event.FirstOrDefaultAsync(m => m.Id == Id);

        if (selectedEvent is null)
        {
            NavigationManager.NavigateTo("/events");
            return;
        }

        // ✅ Check authorization: Admin OR Event Creator
        if (!isAdmin && selectedEvent.CreatedBy != currentUserEmail)
        {
            isUnauthorized = true;
        }
    }

    private async Task DeleteEvent()
    {
        if (selectedEvent is null)
        {
            return;
        }

        // Double-check authorization before deleting
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var currentUserEmail = authState.User.Identity?.Name;
        var isAdmin = authState.User.IsInRole("Administrator");

        // Only creator or admin can delete
        if (!isAdmin && selectedEvent.CreatedBy != currentUserEmail)
        {
            NavigationManager.NavigateTo("/events");
            return;
        }

        using var context = DbFactory.CreateDbContext();

        // Find and remove the event
        var eventToDelete = await context.Event.FindAsync(selectedEvent.Id);
        if (eventToDelete != null)
        {
            context.Event.Remove(eventToDelete);
            await context.SaveChangesAsync();
        }

        NavigationManager.NavigateTo("/events");
    }

    private string GetStatusBadgeClass(string? status)
        => status switch
        {
            "Pending" => "bg-warning text-dark",
            "Approved" => "bg-success text-white",
            "Rejected" => "bg-danger text-white",
            _ => "bg-secondary text-white"
        };
}