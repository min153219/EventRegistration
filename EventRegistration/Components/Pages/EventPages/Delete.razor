@page "/events/delete/{id:int}"
@using Microsoft.EntityFrameworkCore
@using EventRegistration.Domain
@using Microsoft.AspNetCore.Components.Authorization
@inject IDbContextFactory<EventRegistration.Data.EventRegistrationContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Delete Event</PageTitle>

<link rel="stylesheet" href="delete.razor.css" />

<div class="delete-container">
    <div class="warning-banner">
        <h4 class="warning-banner-header">Confirm Deletion</h4>
        <p class="warning-banner-text">Are you sure you want to delete this event? This action cannot be undone.</p>
    </div>

    @if (isUnauthorized)
    {
        <div class="alert-unauthorized">
            <h4>Access Denied</h4>
            <p>You don't have permission to delete this event. Only the event creator or administrators can delete it.</p>
            <a href="/events" class="btn btn-primary">Back to Events</a>
        </div>
    }
    else if (selectedEvent is null)
    {
        <div class="loading-container">
            <div class="spinner"></div>
            <p class="loading-text"><em>Loading event...</em></p>
        </div>
    }
    else
    {
        <div class="delete-layout">
            <div>
                <div class="event-card">
                    <div class="event-card-header">
                        <h5>Event to be Deleted</h5>
                    </div>
                    <div class="event-card-body">
                        <dl class="details-list">
                            <dt class="details-label">Title:</dt>
                            <dd class="details-value">@selectedEvent.Title</dd>

                            <dt class="details-label">Type:</dt>
                            <dd class="details-value">
                                <span class="badge badge-info">@selectedEvent.Type</span>
                            </dd>

                            <dt class="details-label">Event Date:</dt>
                            <dd class="details-value">@selectedEvent.EventDate.ToString("MMMM dd, yyyy")</dd>

                            <dt class="details-label">Location:</dt>
                            <dd class="details-value">@selectedEvent.Location</dd>

                            <dt class="details-label">Capacity:</dt>
                            <dd class="details-value">@selectedEvent.TotalCapacity</dd>

                            <dt class="details-label">Category:</dt>
                            <dd class="details-value">@selectedEvent.Category</dd>

                            <dt class="details-label">Description:</dt>
                            <dd class="details-value">@selectedEvent.Description</dd>

                            <dt class="details-label">Status:</dt>
                            <dd class="details-value">
                                <span class="badge @GetStatusBadgeClass(selectedEvent.Status)">
                                    @selectedEvent.Status
                                </span>
                            </dd>

                            <dt class="details-label">Created By:</dt>
                            <dd class="details-value">@selectedEvent.CreatedBy</dd>

                            <dt class="details-label">Date Created:</dt>
                            <dd class="details-value">@selectedEvent.DateCreated.ToString("MMM dd, yyyy 'at' h:mm tt")</dd>

                            @if (!string.IsNullOrEmpty(selectedEvent.UpdatedBy))
                            {
                                <dt class="details-label">Last Updated By:</dt>
                                <dd class="details-value">@selectedEvent.UpdatedBy</dd>

                                <dt class="details-label">Last Updated:</dt>
                                <dd class="details-value">@selectedEvent.DateUpdated.ToString("MMM dd, yyyy 'at' h:mm tt")</dd>
                            }
                        </dl>
                    </div>
                </div>

                <EditForm method="post" Model="selectedEvent" OnValidSubmit="DeleteEvent" FormName="delete" Enhance>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-danger" disabled="@(selectedEvent is null)">
                            Yes, Delete This Event
                        </button>
                        <a href="/events" class="btn btn-secondary">
                            <span>✕</span> Cancel
                        </a>
                    </div>
                </EditForm>
            </div>

            <div>
                <div class="warning-sidebar">
                    <h5 class="warning-sidebar-title">Warning</h5>
                    <p class="warning-sidebar-text">Deleting this event will permanently remove:</p>
                    <ul class="warning-list">
                        <li>All event information</li>
                        <li>Associated tickets</li>
                        <li>Registration records</li>
                        <li>Payment history</li>
                    </ul>
                    <hr class="divider">
                    <p class="warning-footer">
                        This action cannot be undone. Please make sure you want to proceed.
                    </p>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private Event? selectedEvent;
    private bool isUnauthorized = false;

    protected override async Task OnInitializedAsync()
    {
        // Get current user info
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var currentUserEmail = authState.User.Identity?.Name;
        var isAdmin = authState.User.IsInRole("Administrator");

        using var context = DbFactory.CreateDbContext();
        selectedEvent = await context.Event.FirstOrDefaultAsync(m => m.Id == Id);

        if (selectedEvent is null)
        {
            NavigationManager.NavigateTo("/events");
            return;
        }

        // Check authorization: Admin OR Event Creator
        if (!isAdmin && selectedEvent.CreatedBy != currentUserEmail)
        {
            isUnauthorized = true;
        }
    }

    private async Task DeleteEvent()
    {
        if (selectedEvent is null)
        {
            return;
        }

        // Double-check authorization before deleting
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var currentUserEmail = authState.User.Identity?.Name;
        var isAdmin = authState.User.IsInRole("Administrator");

        // Only creator or admin can delete
        if (!isAdmin && selectedEvent.CreatedBy != currentUserEmail)
        {
            NavigationManager.NavigateTo("/events");
            return;
        }

        using var context = DbFactory.CreateDbContext();

        // Find and remove the event
        var eventToDelete = await context.Event.FindAsync(selectedEvent.Id);
        if (eventToDelete != null)
        {
            context.Event.Remove(eventToDelete);
            await context.SaveChangesAsync();
        }

        NavigationManager.NavigateTo("/events");
    }

    private string GetStatusBadgeClass(string? status)
        => status switch
        {
            "Pending" => "badge-pending",
            "Approved" => "badge-approved",
            "Rejected" => "badge-rejected",
            _ => "badge-secondary"
        };
}