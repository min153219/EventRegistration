@page "/"
@rendermode InteractiveServer
@using EventRegistration.Data
@using EventRegistration.Domain
@using Microsoft.EntityFrameworkCore
@using EventRegistration.Components.Shared
@inject EventRegistrationContext DbContext
@inject NavigationManager Navigation

<PageTitle>Eventora - Home</PageTitle>

<!-- Hero Section -->
<section class="hero">
    <h1>Welcome to Eventora</h1>
    <p>Discover amazing events, connect with people, and create unforgettable experiences</p>
</section>

<!-- Explore Events Section -->
<section class="explore-section">
    <h2 class="section-title">Explore Events</h2>
    <p class="section-subtitle">Find the perfect event for you from various categories</p>

    <div class="category-grid">
        <div class="category-card" @onclick="@(() => NavigateToCategory("Music"))">
            <div class="category-icon">🎵</div>
            <h3>Music & Concerts</h3>
            <p>Live performances, festivals, and music events</p>
        </div>
        <div class="category-card" @onclick="@(() => NavigateToCategory("Educational"))">
            <div class="category-icon">📚</div>
            <h3>Educational</h3>
            <p>Webinars, workshops, and learning sessions</p>
        </div>
        <div class="category-card" @onclick="@(() => NavigateToCategory("Arts"))">
            <div class="category-icon">🎨</div>
            <h3>Arts & Culture</h3>
            <p>Exhibitions, theater, and cultural events</p>
        </div>
        <div class="category-card" @onclick="@(() => NavigateToCategory("Professional"))">
            <div class="category-icon">💼</div>
            <h3>Professional</h3>
            <p>Networking, conferences, and career events</p>
        </div>
    </div>
</section>

<!-- Highlighted Events - Now Dynamic with Countdown! -->
<section class="highlighted-events">
    <div class="container">
        <h2 class="section-title">Featured Events</h2>
        <p class="section-subtitle">Check out our handpicked events happening soon</p>

        @if (isLoading)
        {
            <div class="loading-message">
                <p>Loading featured events...</p>
            </div>
        }
        else if (featuredEvents != null && featuredEvents.Any())
        {
            <div class="events-grid">
                @foreach (var evt in featuredEvents)
                {
                    <div class="event-card">
                        <div class="event-image">@GetCategoryIcon(evt.Category)</div>
                        <div class="event-content">
                            <div class="event-header">
                                <span class="event-tag">@evt.Category</span>
                                <!-- ADD COUNTDOWN HERE -->
                                <EventCountdown EventDate="@evt.EventDate" />
                            </div>
                            <h3>@evt.Title</h3>
                            <p class="event-details">📅 @evt.EventDate.ToString("MMM dd, yyyy") | 📍 @GetShortLocation(evt.Location)</p>
                            <p class="event-price">
                                @if (evt.Tickets != null && evt.Tickets.Any())
                                {
                                    var minPrice = evt.Tickets.Min(t => t.Price);
                                    if (minPrice == 0)
                                    {
                                        <text>Free</text>
                                    }
                                    else
                                    {
                                        <text>$@minPrice.ToString("F2")</text>
                                    }
                                }
                                else
                                {
                                    <text>Free</text>
                                }
                            </p>
                            <button class="btn-register" @onclick="@(() => NavigateToEvent(evt.Id))">
                                Register Now
                            </button>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="no-events-message">
                <p>No upcoming featured events available at the moment.</p>
                <button class="btn-primary" @onclick="@(() => Navigation.NavigateTo("/explore-events"))">
                    Explore All Events
                </button>
            </div>
        }
    </div>
</section>

<!-- Footer -->
<footer class="footer">
    <p>&copy; 2026 Eventora. All rights reserved. | Making events accessible for everyone</p>
</footer>

@code {
    private List<Event> featuredEvents = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadFeaturedEvents();
    }

    private async Task LoadFeaturedEvents()
    {
        isLoading = true;

        try
        {
            var now = DateTime.Now;

            // Load featured events that are UPCOMING ONLY (EventDate >= Now)
            featuredEvents = await DbContext.Event
                .Include(e => e.Tickets)
                .Where(e => e.IsFeatured == true 
                         && e.Status == "Approved"
                         && e.EventDate >= now) // ← FILTER OUT PAST EVENTS
                .OrderBy(e => e.EventDate) // Order by date (soonest first)
                .Take(6) // Show up to 6 featured events
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading featured events: {ex.Message}");
            featuredEvents = new List<Event>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void NavigateToCategory(string category)
    {
        Navigation.NavigateTo($"/explore-events?category={category}");
    }

    private void NavigateToEvent(int eventId)
    {
        Navigation.NavigateTo($"/event-details/{eventId}");
    }

    private string GetCategoryIcon(string? category)
    {
        if (string.IsNullOrEmpty(category))
            return "📅";

        return category switch
        {
            "Music" => "🎸",
            "Educational" => "💻",
            "Arts" => "🎭",
            "Professional" => "🎤",
            "Entertainment" => "🎬",
            "Sports" => "🏃",
            _ => "📅"
        };
    }

    private string GetShortLocation(string? location)
    {
        if (string.IsNullOrEmpty(location))
            return "TBA";

        // Shorten long location names for display
        if (location.Length > 30)
            return location.Substring(0, 27) + "...";

        return location;
    }
}
