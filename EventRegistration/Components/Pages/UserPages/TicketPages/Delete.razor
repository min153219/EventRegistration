@page "/tickets/delete"
@using Microsoft.EntityFrameworkCore
@using EventRegistration.Domain
@inject IDbContextFactory<EventRegistration.Data.EventRegistrationContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Delete Ticket</PageTitle>

<div class="page-container">
    <div class="page-header">
        <h1>Delete Ticket</h1>
        <p class="warning-text">Are you sure you want to delete this ticket?</p>
    </div>

    @if (selectedTicket is null)
    {
        <div class="loading-container">
            <p class="loading-text">Loading...</p>
        </div>
    }
    else
    {
        <div class="ticket-details-container">
            <h2 class="section-title">Ticket Details</h2>

            <div class="details-grid">
                <div class="detail-item">
                    <span class="detail-label">Price</span>
                    <span class="detail-value">@selectedTicket.Price</span>
                </div>

                <div class="detail-item">
                    <span class="detail-label">Type</span>
                    <span class="detail-value">@selectedTicket.Type</span>
                </div>

                <div class="detail-item">
                    <span class="detail-label">Event ID</span>
                    <span class="detail-value">@selectedTicket.EventId</span>
                </div>

                <div class="detail-item">
                    <span class="detail-label">Date Created</span>
                    <span class="detail-value">@selectedTicket.DateCreated</span>
                </div>

                <div class="detail-item">
                    <span class="detail-label">Date Updated</span>
                    <span class="detail-value">@selectedTicket.DateUpdated</span>
                </div>

                <div class="detail-item">
                    <span class="detail-label">Created By</span>
                    <span class="detail-value">@selectedTicket.CreatedBy</span>
                </div>

                <div class="detail-item">
                    <span class="detail-label">Updated By</span>
                    <span class="detail-value">@selectedTicket.UpdatedBy</span>
                </div>
            </div>

            <EditForm method="post" Model="selectedTicket" OnValidSubmit="DeleteTicket" FormName="delete" Enhance>
                <div class="form-actions">
                    <button type="submit" class="btn btn-danger" disabled="@(selectedTicket is null)">Delete Ticket</button>
                    <a href="@($"/events/{selectedTicket.EventId}/tickets")" class="btn btn-secondary">Cancel</a>
                </div>
            </EditForm>
        </div>

        <div class="back-link">
            <a href="@($"/events/{selectedTicket.EventId}/tickets")">← Back to Ticket List</a>
        </div>
    }
</div>

@code {
    private Ticket? selectedTicket;

    [SupplyParameterFromQuery]
    private int Id { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        selectedTicket = await context.Ticket.FirstOrDefaultAsync(m => m.Id == Id);

        if (selectedTicket is null)
        {
            NavigationManager.NavigateTo("notfound");
        }
    }

    private async Task DeleteTicket()
    {
        using var context = DbFactory.CreateDbContext();
        context.Ticket.Remove(selectedTicket!);
        await context.SaveChangesAsync();
        NavigationManager.NavigateTo($"/events/{selectedTicket!.EventId}/tickets");
    }
}
