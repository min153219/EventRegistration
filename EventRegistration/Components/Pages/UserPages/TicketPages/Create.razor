@page "/events/{eventId:int}/tickets/create"
@using Microsoft.EntityFrameworkCore
@using EventRegistration.Domain
@using Microsoft.AspNetCore.Components.Authorization
@inject IDbContextFactory<EventRegistration.Data.EventRegistrationContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Create Ticket</PageTitle>

<link rel="stylesheet" href="Create.razor.css" />

<div class="create-container">
    <h1 class="page-title">Create New Ticket</h1>
    <p class="page-subtitle">Fill in the details below to create a ticket for this event.</p>

    @if (selectedEvent != null)
    {
        <div class="event-info-banner">
            <h2>@selectedEvent.Title</h2>
            <p>@selectedEvent.EventDate.ToString("dddd, MMMM dd, yyyy") | 📍 @selectedEvent.Location</p>
        </div>
    }

    <div class="form-layout">
        <div class="form-section">
            <EditForm method="post" Model="@newTicket" OnValidSubmit="@AddTicket" FormName="CreateTicketForm" Enhance>
                <DataAnnotationsValidator />
                <ValidationSummary class="validation-summary" role="alert" />

                <div class="form-row">
                    <div class="form-group">
                        <label for="price" class="form-label">
                            Price: <span class="required">*</span>
                        </label>
                        
                        <InputNumber id="price" @bind-Value="newTicket.Price" class="form-control" placeholder="0.00" step="0.01" />
                       
                        <ValidationMessage For="() => newTicket.Price" class="text-danger" />
                    </div>

                    <div class="form-group">
                        <label for="type" class="form-label">
                            Ticket Type: <span class="required">*</span>
                        </label>
                        <InputSelect id="type" @bind-Value="newTicket.Type" class="form-control">
                            <option value="">Select Type</option>
                            <option value="VIP">VIP</option>
                            <option value="General Admission">General Admission</option>
                            <option value="Student">Student</option>
                            <option value="Early Bird">Early Bird</option>
                            <option value="Group">Group</option>
                        </InputSelect>
                        <ValidationMessage For="() => newTicket.Type" class="text-danger" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="createdby" class="form-label">
                            Created By:
                        </label>
                        <InputText id="createdby" @bind-Value="newTicket.CreatedBy" class="form-control" disabled />
                    </div>

                    <div class="form-group">
                        <label for="updatedby" class="form-label">
                            Updated By:
                        </label>
                        <InputText id="updatedby" @bind-Value="newTicket.UpdatedBy" class="form-control" disabled />
                    </div>
                </div>

                <div class="alert alert-info">
                    
                    <div>
                        <strong>Note:</strong> Your ticket will be created and immediately available for the event.
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        Create Ticket
                    </button>
                    <a href="@($"/events/{EventId}/tickets")" class="btn btn-secondary">
                        Cancel
                    </a>
                </div>
            </EditForm>
        </div>

        <div>
            <div class="sidebar-card">
                <h3 class="sidebar-title">
                    Tips for Creating Tickets
                </h3>
                <ul class="tips-list">
                    <li>Set competitive and fair pricing</li>
                    <li>Choose a clear ticket type name</li>
                    <li>Consider early bird discounts</li>
                    <li>Offer group rates when applicable</li>
                    <li>Double-check pricing before submitting</li>
                </ul>
            </div>

            <div class="approval-card">
                <h3 class="approval-title">
                    Ticket Information
                </h3>
                <p class="approval-text">
                    Once created, tickets will be available immediately for users to purchase. Make sure all details are correct before submitting.
                </p>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int EventId { get; set; }

    [SupplyParameterFromForm]
    private Ticket newTicket { get; set; } = new();

    private Event? selectedEvent;

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();

        selectedEvent = await context.Event
            .AsNoTracking()
            .FirstOrDefaultAsync(e => e.Id == EventId);

        if (selectedEvent is null)
        {
            NavigationManager.NavigateTo("/events");
            return;
        }

        // Get current user
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var currentUserEmail = authState.User.Identity?.Name;

        // Initialize audit fields
        newTicket.CreatedBy = currentUserEmail ?? "Unknown";
        newTicket.UpdatedBy = currentUserEmail ?? "Unknown";
    }

    private async Task AddTicket()
    {
        newTicket.EventId = EventId;
        newTicket.DateCreated = DateTime.Now;
        newTicket.DateUpdated = DateTime.Now;

        using var context = DbFactory.CreateDbContext();
        context.Ticket.Add(newTicket);
        await context.SaveChangesAsync();

        NavigationManager.NavigateTo($"/events/{EventId}/tickets");
    }
}