@page "/events/{eventId:int}/tickets"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.QuickGrid
@using EventRegistration.Domain
@using EventRegistration.Data
@using Microsoft.AspNetCore.Components.Authorization
@implements IAsyncDisposable
@inject IDbContextFactory<EventRegistration.Data.EventRegistrationContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Event Tickets</PageTitle>

<link href="/index.razor.css" rel="stylesheet" />

<div class="tickets-container">
    @if (isUnauthorized)
    {
        <div class="alert-unauthorized">
            <h4>Access Denied</h4>
            <p>You don't have permission to view tickets for this event. Only the event creator can manage tickets.</p>
            <a href="/events" class="btn-create">Back to Events</a>
        </div>
    }
    else if (selectedEvent is null)
    {
        <div class="loading">
            <p><em>Loading event details...</em></p>
        </div>
    }
    else
    {
        <div class="page-header">
            <h1>@selectedEvent.Title - Tickets</h1>
        </div>

        <div class="event-info-card">
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Event Date</span>
                    <span class="info-value">@selectedEvent.EventDate.ToString("dd MMM yyyy")</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Location</span>
                    <span class="info-value">@selectedEvent.Location</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Total Capacity</span>
                    <span class="info-value">
                        <span class="badge badge-capacity">@selectedEvent.TotalCapacity seats</span>
                    </span>
                </div>
            </div>
        </div>

        <div class="action-bar">
            <a href="@($"/events/{EventId}/tickets/create")" class="btn-create">
                Create New Ticket
            </a>
        </div>

        <div class="table-container">
            <QuickGrid Class="table" Items="context.Ticket.Where(t => t.EventId == EventId)">
                <PropertyColumn Property="ticket => ticket.Price" Title="Price" />
                <PropertyColumn Property="ticket => ticket.Type" Title="Type" />
                <PropertyColumn Property="ticket => ticket.DateCreated" Title="Created" Format="dd/MM/yyyy HH:mm" />
                <PropertyColumn Property="ticket => ticket.DateUpdated" Title="Updated" Format="dd/MM/yyyy HH:mm" />
                <PropertyColumn Property="ticket => ticket.CreatedBy" Title="Created By" />
                <TemplateColumn Title="Actions" Context="ticket">
                    <div class="action-links">
                        <a href="@($"/tickets/edit?id={ticket.Id}")">Edit</a>
                        <span>|</span>
                        <a href="@($"/tickets/details?id={ticket.Id}")">Details</a>
                        <span>|</span>
                        <a href="@($"/tickets/delete?id={ticket.Id}")">Delete</a>
                    </div>
                </TemplateColumn>
            </QuickGrid>
        </div>

        <div class="action-bar" style="margin-top: 2rem;">
            <a href="/events" class="btn-back">← Back to Events</a>
        </div>
    }
</div>

@code {
    [Parameter]
    public int EventId { get; set; }

    private EventRegistrationContext context = default!;
    private Event? selectedEvent;
    private bool isUnauthorized = false;

    protected override async Task OnInitializedAsync()
    {
        // Get current user info
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var currentUserEmail = authState.User.Identity?.Name;
        var isAdmin = authState.User.IsInRole("Administrator");

        context = DbFactory.CreateDbContext();

        selectedEvent = await context.Event
            .AsNoTracking()
            .FirstOrDefaultAsync(e => e.Id == EventId);

        if (selectedEvent is null)
        {
            NavigationManager.NavigateTo("/events");
            return;
        }

        // Check authorization: Admin OR Event Creator
        if (!isAdmin && selectedEvent.CreatedBy != currentUserEmail)
        {
            isUnauthorized = true;
        }
    }

    public async ValueTask DisposeAsync() => await context.DisposeAsync();
}