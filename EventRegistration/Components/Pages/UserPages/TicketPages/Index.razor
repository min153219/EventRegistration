@page "/events/{eventId:int}/tickets"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.QuickGrid
@using EventRegistration.Domain
@using EventRegistration.Data
@using Microsoft.AspNetCore.Components.Authorization
@implements IAsyncDisposable
@inject IDbContextFactory<EventRegistration.Data.EventRegistrationContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Event Tickets</PageTitle>

<div class="page-container">
    @if (isUnauthorized)
    {
        <div class="alert alert-danger">
            <h2 class="alert-title">Access Denied</h2>
            <p class="alert-message">You don't have permission to view tickets for this event. Only the event creator can manage tickets.</p>
            <a href="/events" class="btn btn-primary">Back to Events</a>
        </div>
    }
    else if (selectedEvent is null)
    {
        <div class="loading-container">
            <p class="loading-text">Loading...</p>
        </div>
    }
    else
    {
        <div class="page-header">
            <h1>@selectedEvent.Title - Tickets</h1>
        </div>

        <div class="event-info-card">
            <div class="event-details">
                <div class="detail-item">
                    <span class="detail-label">Event Date:</span>
                    <span class="detail-value">@selectedEvent.EventDate.ToString("dd/MM/yyyy")</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Location:</span>
                    <span class="detail-value">@selectedEvent.Location</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Total Capacity:</span>
                    <span class="detail-value">@selectedEvent.TotalCapacity</span>
                </div>
            </div>
        </div>

        <div class="action-bar">
            <a href="@($"/events/{EventId}/tickets/create")" class="btn btn-primary">Create New Ticket</a>
        </div>

        <div class="tickets-table-container">
            <QuickGrid Class="tickets-table" Items="context.Ticket.Where(t => t.EventId == EventId)">
                <PropertyColumn Property="ticket => ticket.Price" />
                <PropertyColumn Property="ticket => ticket.Type" />
                <PropertyColumn Property="ticket => ticket.DateCreated" Title="Created" />
                <PropertyColumn Property="ticket => ticket.DateUpdated" Title="Updated" />
                <PropertyColumn Property="ticket => ticket.CreatedBy" Title="Created By" />
                <PropertyColumn Property="ticket => ticket.UpdatedBy" Title="Updated By" />
                <TemplateColumn Title="Actions" Context="ticket">
                    <div class="action-buttons">
                        <a href="@($"/tickets/edit?id={ticket.Id}")" class="btn btn-primary">Edit</a>
                        <a href="@($"/tickets/details?id={ticket.Id}")" class="btn btn-secondary">Details</a>
                        <a href="@($"/tickets/delete?id={ticket.Id}")" class="btn btn-danger">Delete</a>
                    </div>
                </TemplateColumn>
            </QuickGrid>
        </div>

        <div class="back-link">
            <a href="/events">← Back to Events</a>
        </div>
    }
</div>

@code {
    [Parameter]
    public int EventId { get; set; }

    private EventRegistrationContext context = default!;
    private Event? selectedEvent;
    private bool isUnauthorized = false;

    protected override async Task OnInitializedAsync()
    {
        // Get current user info
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var currentUserEmail = authState.User.Identity?.Name;
        var isAdmin = authState.User.IsInRole("Administrator");

        context = DbFactory.CreateDbContext();
        selectedEvent = await context.Event
            .AsNoTracking()
            .FirstOrDefaultAsync(e => e.Id == EventId);

        if (selectedEvent is null)
        {
            NavigationManager.NavigateTo("/events");
            return;
        }

        // ✅ Check authorization: Admin OR Event Creator
        if (!isAdmin && selectedEvent.CreatedBy != currentUserEmail)
        {
            isUnauthorized = true;
        }
    }

    public async ValueTask DisposeAsync() => await context.DisposeAsync();
}
