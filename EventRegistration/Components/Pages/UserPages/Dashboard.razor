@page "/user/dashboard"
@rendermode InteractiveServer
@using EventRegistration.Data
@using EventRegistration.Domain
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@inject EventRegistrationContext DbContext
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JSRuntime

<PageTitle>My Dashboard - Eventora</PageTitle>

<link href="/Dashboard.css" rel="stylesheet" />

<div class="dashboard-page">
    @if (isLoading)
    {
        <div class="dashboard-loading">
            <div class="loading-spinner"></div>
            <p>Loading your dashboard...</p>
        </div>
    }
    else
    {
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <h1 class="dashboard-title">📊 My Dashboard</h1>
            <p class="dashboard-welcome">Welcome back, <strong>@userName</strong>!</p>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card stat-primary">
                <div class="stat-icon">🎫</div>
                <div class="stat-content">
                    <div class="stat-value">@totalRegistrations</div>
                    <div class="stat-label">Registered Events</div>
                </div>
            </div>

            <div class="stat-card stat-success">
                <div class="stat-icon">📝</div>
                <div class="stat-content">
                    <div class="stat-value">@totalEventsCreated</div>
                    <div class="stat-label">Events Created</div>
                </div>
            </div>

            <div class="stat-card stat-info">
                <div class="stat-icon">👥</div>
                <div class="stat-content">
                    <div class="stat-value">@totalAttendees</div>
                    <div class="stat-label">Total Attendees</div>
                </div>
            </div>

            <div class="stat-card stat-warning">
                <div class="stat-icon">💰</div>
                <div class="stat-content">
                    <div class="stat-value">$@totalRevenue.ToString("F2")</div>
                    <div class="stat-label">Total Revenue</div>
                </div>
            </div>
        </div>

        <!-- My Registrations Section -->
        <div class="dashboard-section">
            <div class="section-header">
                <h2 class="section-title">🎫 My Registrations</h2>
                <div class="filter-tabs">
                    <button class="filter-tab @(registrationFilter == "all" ? "active" : "")"
                            @onclick="@(() => SetRegistrationFilter("all"))">
                        All (@myRegistrations.Count)
                    </button>
                    <button class="filter-tab @(registrationFilter == "upcoming" ? "active" : "")"
                            @onclick="@(() => SetRegistrationFilter("upcoming"))">
                        Upcoming (@upcomingRegistrations.Count)
                    </button>
                    <button class="filter-tab @(registrationFilter == "past" ? "active" : "")"
                            @onclick="@(() => SetRegistrationFilter("past"))">
                        Past (@pastRegistrations.Count)
                    </button>
                </div>
            </div>

            <div class="cards-grid">
                @if (filteredRegistrations.Any())
                {
                    @foreach (var registration in filteredRegistrations)
                    {
                        <div class="event-card registration-card">
                            <div class="card-header">
                                <span class="category-badge">@registration.Event?.Category</span>
                                <span class="status-badge status-@registration.Status?.ToLower()">
                                    @registration.Status
                                </span>
                            </div>

                            <h3 class="card-title">@registration.Event?.Title</h3>

                            <div class="card-details">
                                <div class="detail-item">
                                    <span class="detail-icon">📅</span>
                                    <span>@registration.Event?.EventDate.ToString("MMMM dd, yyyy")</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-icon">🕐</span>
                                    <span>@registration.Event?.EventDate.ToString("h:mm tt")</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-icon">📍</span>
                                    <span>@registration.Event?.Location</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-icon">🎫</span>
                                    <span>@registration.Ticket?.Type x @registration.Quantity</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-icon">💰</span>
                                    <span class="detail-price">
                                        @if (registration.TotalAmount == 0)
                                        {
                                            <text>Free</text>
                                        }
                                        else
                                        {
                                            <text>$@registration.TotalAmount.ToString("F2")</text>
                                        }
                                    </span>
                                </div>
                            </div>

                            <div class="card-actions">
                                <button class="btn-secondary" @onclick="@(() => ViewEventDetails(registration.EventId))">
                                    View Details
                                </button>
                                @if (registration.Status == "Confirmed" && registration.Event?.EventDate > DateTime.Now)
                                {
                                    <button class="btn-danger" @onclick="@(() => CancelRegistration(registration.Id))">
                                        Cancel
                                    </button>
                                }
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="empty-state">
                        <div class="empty-icon">🎫</div>
                        <h3>No registrations yet</h3>
                        <p>Start exploring events and register for your first one!</p>
                        <button class="btn-primary" @onclick="GoToExploreEvents">
                            Explore Events
                        </button>
                    </div>
                }
            </div>
        </div>

        <!-- My Created Events Section -->
        <div class="dashboard-section">
            <div class="section-header">
                <h2 class="section-title">📝 My Created Events</h2>
                <div class="section-actions">
                    <button class="btn-primary" @onclick="GoToCreateEvent">
                        + Create New Event
                    </button>
                </div>
            </div>

            <div class="filter-tabs">
                <button class="filter-tab @(createdEventFilter == "all" ? "active" : "")"
                        @onclick="@(() => SetCreatedEventFilter("all"))">
                    All (@myCreatedEvents.Count)
                </button>
                <button class="filter-tab @(createdEventFilter == "upcoming" ? "active" : "")"
                        @onclick="@(() => SetCreatedEventFilter("upcoming"))">
                    Upcoming (@upcomingCreatedEvents.Count)
                </button>
                <button class="filter-tab @(createdEventFilter == "past" ? "active" : "")"
                        @onclick="@(() => SetCreatedEventFilter("past"))">
                    Past (@pastCreatedEvents.Count)
                </button>
            </div>

            <div class="cards-grid">
                @if (filteredCreatedEvents.Any())
                {
                    @foreach (var evt in filteredCreatedEvents)
                    {
                        var eventStats = eventStatistics.FirstOrDefault(s => s.EventId == evt.Id);
                        var attendeeCount = eventStats?.AttendeeCount ?? 0;
                        var revenue = eventStats?.TotalRevenue ?? 0;
                        var percentFull = evt.TotalCapacity > 0 ? (attendeeCount * 100.0 / evt.TotalCapacity) : 0;

                        <div class="event-card created-event-card">
                            <div class="card-header">
                                <span class="category-badge">@evt.Category</span>
                                @if (evt.IsFeatured)
                                {
                                    <span class="featured-badge">⭐ Featured</span>
                                }
                            </div>

                            <h3 class="card-title">@evt.Title</h3>

                            <div class="card-details">
                                <div class="detail-item">
                                    <span class="detail-icon">📅</span>
                                    <span>@evt.EventDate.ToString("MMMM dd, yyyy")</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-icon">📍</span>
                                    <span>@evt.Location</span>
                                </div>
                            </div>

                            <!-- Event Statistics -->
                            <div class="event-stats">
                                <div class="stat-item">
                                    <span class="stat-icon">👥</span>
                                    <div class="stat-info">
                                        <div class="stat-number">@attendeeCount / @evt.TotalCapacity</div>
                                        <div class="stat-text">Registered</div>
                                    </div>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-icon">💰</span>
                                    <div class="stat-info">
                                        <div class="stat-number">$@revenue.ToString("F2")</div>
                                        <div class="stat-text">Revenue</div>
                                    </div>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-icon">📊</span>
                                    <div class="stat-info">
                                        <div class="stat-number">@percentFull.ToString("F0")%</div>
                                        <div class="stat-text">Capacity</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Progress Bar -->
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: @percentFull%"></div>
                            </div>

                            <div class="card-actions">
                                <button class="btn-info" @onclick="@(() => ViewAttendees(evt.Id))">
                                    👥 Attendees
                                </button>
                                <button class="btn-secondary" @onclick="@(() => EditEvent(evt.Id))">
                                    ✏️ Edit
                                </button>
                                <button class="btn-danger" @onclick="@(() => DeleteEvent(evt.Id))">
                                    🗑️ Delete
                                </button>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="empty-state">
                        <div class="empty-icon">📝</div>
                        <h3>No events created yet</h3>
                        <p>Start creating your first event and manage attendees!</p>
                        <button class="btn-primary" @onclick="GoToCreateEvent">
                            + Create Your First Event
                        </button>
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    private bool isLoading = true;
    private string currentUserEmail = "";
    private string userName = "";

    // Registrations
    private List<EventRegistration.Domain.Registration> myRegistrations = new();
    private List<EventRegistration.Domain.Registration> upcomingRegistrations = new();
    private List<EventRegistration.Domain.Registration> pastRegistrations = new();
    private List<EventRegistration.Domain.Registration> filteredRegistrations = new();
    private string registrationFilter = "all";

    // Created Events
    private List<Event> myCreatedEvents = new();
    private List<Event> upcomingCreatedEvents = new();
    private List<Event> pastCreatedEvents = new();
    private List<Event> filteredCreatedEvents = new();
    private string createdEventFilter = "all";

    // Event Statistics
    private List<EventStatistic> eventStatistics = new();

    // Stats
    private int totalRegistrations => myRegistrations.Count;
    private int totalEventsCreated => myCreatedEvents.Count;
    private int totalAttendees = 0;
    private decimal totalRevenue = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserData();
        await LoadDashboardData();
    }

    private async Task LoadUserData()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                currentUserEmail = user.Identity.Name ?? "";
                // Extract name from email (before @)
                userName = currentUserEmail.Split('@')[0];
            }
            else
            {
                // Redirect to login if not authenticated
                Navigation.NavigateTo("/Account/Login");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading user: {ex.Message}");
        }
    }

    private async Task LoadDashboardData()
    {
        isLoading = true;

        try
        {
            // Load registrations
            myRegistrations = await DbContext.Registration
                .Include(r => r.Event)
                .Include(r => r.Ticket)
                .Where(r => r.Email == currentUserEmail)
                .OrderByDescending(r => r.Event!.EventDate)
                .ToListAsync();

            // Filter registrations by time
            var now = DateTime.Now;
            upcomingRegistrations = myRegistrations
                .Where(r => r.Event!.EventDate >= now)
                .ToList();
            pastRegistrations = myRegistrations
                .Where(r => r.Event!.EventDate < now)
                .ToList();

            // Load created events
            myCreatedEvents = await DbContext.Event
                .Include(e => e.Tickets)
                .Where(e => e.CreatedBy == currentUserEmail)
                .OrderByDescending(e => e.EventDate)
                .ToListAsync();

            // Filter created events by time
            upcomingCreatedEvents = myCreatedEvents
                .Where(e => e.EventDate >= now)
                .ToList();
            pastCreatedEvents = myCreatedEvents
                .Where(e => e.EventDate < now)
                .ToList();

            // Calculate statistics for created events
            foreach (var evt in myCreatedEvents)
            {
                var registrations = await DbContext.Registration
                    .Where(r => r.EventId == evt.Id)
                    .ToListAsync();

                var attendeeCount = registrations.Count;
                var revenue = registrations.Sum(r => r.TotalAmount);

                eventStatistics.Add(new EventStatistic
                {
                    EventId = evt.Id,
                    AttendeeCount = attendeeCount,
                    TotalRevenue = revenue
                });

                totalAttendees += attendeeCount;
                totalRevenue += revenue;
            }

            // Set initial filters
            SetRegistrationFilter("all");
            SetCreatedEventFilter("all");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void SetRegistrationFilter(string filter)
    {
        registrationFilter = filter;
        filteredRegistrations = filter switch
        {
            "upcoming" => upcomingRegistrations,
            "past" => pastRegistrations,
            _ => myRegistrations
        };
        StateHasChanged();
    }

    private void SetCreatedEventFilter(string filter)
    {
        createdEventFilter = filter;
        filteredCreatedEvents = filter switch
        {
            "upcoming" => upcomingCreatedEvents,
            "past" => pastCreatedEvents,
            _ => myCreatedEvents
        };
        StateHasChanged();
    }

    private void ViewEventDetails(int eventId)
    {
        Navigation.NavigateTo($"/event-details/{eventId}");
    }

    private async Task CancelRegistration(int registrationId)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to cancel this registration?"))
        {
            try
            {
                var registration = await DbContext.Registration.FindAsync(registrationId);
                if (registration != null)
                {
                    registration.Status = "Cancelled";
                    registration.DateUpdated = DateTime.Now;
                    registration.UpdatedBy = currentUserEmail;

                    await DbContext.SaveChangesAsync();
                    await LoadDashboardData(); // Reload data
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error cancelling registration: {ex.Message}");
            }
        }
    }

    private void GoToExploreEvents()
    {
        Navigation.NavigateTo("/explore-events");
    }

    private void GoToCreateEvent()
    {
        Navigation.NavigateTo("/Events/Create");
    }

    private void ViewAttendees(int eventId)
    {
        Navigation.NavigateTo($"/events/attendees/{eventId}");
    }

    private void EditEvent(int eventId)
    {
        Navigation.NavigateTo($"/Events/Edit/{eventId}");
    }

    private async Task DeleteEvent(int eventId)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this event? This action cannot be undone."))
        {
            Navigation.NavigateTo($"/Events/Delete/{eventId}");
        }
    }

    // Helper class for event statistics
    private class EventStatistic
    {
        public int EventId { get; set; }
        public int AttendeeCount { get; set; }
        public decimal TotalRevenue { get; set; }
    }
}
