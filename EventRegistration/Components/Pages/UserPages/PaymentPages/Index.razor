@page "/events/{eventId:int}/payments"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.QuickGrid
@using EventRegistration.Domain
@using EventRegistration.Data
@implements IAsyncDisposable
@inject IDbContextFactory<EventRegistration.Data.EventRegistrationContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Event Payments</PageTitle>

@if (selectedEvent is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <h1>@selectedEvent.Title - Payments Received</h1>

    <div class="card mb-4">
        <div class="card-body">
            <h5>Payment Summary</h5>
            <div class="row">
                <div class="col-md-4">
                    <p><strong>Total Payments:</strong> @totalPayments</p>
                </div>
                @*<div class="col-md-4">
                    <p><strong>Total Revenue:</strong> @selectedEvent.Currency @totalRevenue.ToString("F2")</p>
                </div>
                <div class="col-md-4">
                    <p><strong>Average Payment:</strong> @selectedEvent.Currency @(totalPayments > 0 ? (totalRevenue / totalPayments).ToString("F2") : "0.00")</p>
                </div> *@
            </div>
        </div>
    </div>

    <h4>Payment History</h4>
    <QuickGrid Class="table" Items="GetEventPayments()">
        <PropertyColumn Property="p => p.PaymentDate" Title="Date" />
        <PropertyColumn Property="p => p.Amount" Title="Amount" />
        <PropertyColumn Property="p => p.Currency" />
        <PropertyColumn Property="p => p.PaymentMethod" Title="Method" />
        <PropertyColumn Property="p => p.RegistrationId" Title="Registration ID" />
        <PropertyColumn Property="p => p.CreatedBy" Title="Paid By" />
        <TemplateColumn Title="Actions">
            <a href="@($"/payments/details?id={context.Id}")">View Details</a>
        </TemplateColumn>
    </QuickGrid>
}

<div class="mt-3">
    <a href="/events">Back to Events</a>
</div>

@code {
    [Parameter]
    public int EventId { get; set; }

    private EventRegistrationContext context = default!;
    private Event? selectedEvent;
    private int totalPayments = 0;
    private decimal totalRevenue = 0;

    protected override async Task OnInitializedAsync()
    {
        context = DbFactory.CreateDbContext();
        selectedEvent = await context.Event
            .AsNoTracking()
            .FirstOrDefaultAsync(e => e.Id == EventId);

        if (selectedEvent is null)
        {
            NavigationManager.NavigateTo("/events");
            return;
        }

        // Calculate totals - get all registrations for this event
        var eventRegistrationIds = await context.Registration
            .Where(r => r.EventId == EventId)
            .Select(r => r.Id)
            .ToListAsync();

        var eventPayments = await context.Payment
            .Where(p => eventRegistrationIds.Contains(p.RegistrationId))
            .ToListAsync();

        totalPayments = eventPayments.Count;
        totalRevenue = eventPayments.Sum(p => p.Amount);
    }

    private IQueryable<Payment> GetEventPayments()
    {
        var registrationIds = context.Registration
            .Where(r => r.EventId == EventId)
            .Select(r => r.Id);

        return context.Payment
            .Where(p => registrationIds.Contains(p.RegistrationId))
            .OrderByDescending(p => p.PaymentDate);
    }

    public async ValueTask DisposeAsync()
    {
        if (context != null)
        {
            await context.DisposeAsync();
        }
    }
}